name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
    paths:
      - 'docs/**'
      - 'website/**'
      - '.github/workflows/github-pages.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'docs/**'
      - 'website/**'
  workflow_dispatch: # Allow manual trigger

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Build job
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install website dependencies
        working-directory: website
        run: pnpm install --frozen-lockfile

      - name: Install docs dependencies
        working-directory: docs
        run: pnpm install --frozen-lockfile

      - name: Build website (landing page)
        working-directory: website
        run: pnpm build
        env:
          NODE_ENV: production
          # Set base path for GitHub Pages if using repo name in URL
          # Uncomment and adjust if your site is at https://username.github.io/repo-name/
          # BASE_PATH: /${{ github.event.repository.name }}

      - name: Build docs (Fumadocs)
        working-directory: docs
        run: pnpm build
        env:
          NODE_ENV: production
          # Set base path for GitHub Pages if using repo name in URL
          # Uncomment and adjust if your site is at https://username.github.io/repo-name/
          # BASE_PATH: /${{ github.event.repository.name }}

      - name: Merge website and docs
        run: |
          echo "ğŸ“¦ Merging website landing page and docs..."

          # Create output directory
          mkdir -p _site

          # Copy docs (main content) to root
          cp -r docs/out/* _site/

          # Copy website (landing page) to /landing subdirectory
          mkdir -p _site/landing
          cp -r website/dist/* _site/landing/

          # Create index redirect if docs don't have index.html
          if [ ! -f _site/index.html ]; then
            cat > _site/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <title>Redirecting...</title>
            <meta http-equiv="refresh" content="0; url=/docs">
            <link rel="canonical" href="/docs" />
          </head>
          <body>
            <p>Redirecting to <a href="/docs">documentation</a>...</p>
          </body>
          </html>
          EOF
          fi

          # Create .nojekyll to bypass Jekyll processing
          touch _site/.nojekyll

          echo "âœ… Build complete! Static files ready in _site/"
          echo "ğŸ“ Directory structure:"
          ls -la _site/

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'

      - name: Upload build artifacts (for PR preview)
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: github-pages-build
          path: _site/
          retention-days: 7

  # Deployment job (only on push to main)
  deploy:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Output deployment URL
        run: |
          echo "ğŸš€ Deployed to: ${{ steps.deployment.outputs.page_url }}"
          echo "ğŸ“š Docs: ${{ steps.deployment.outputs.page_url }}docs"
          echo "ğŸŒ Landing: ${{ steps.deployment.outputs.page_url }}landing"

  # Comment on PR with build info
  comment-pr:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    needs: build
    permissions:
      pull-requests: write
    steps:
      - name: Comment PR with build status
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;

            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ“š Documentation Build Status

            âœ… Build completed successfully!

            **Build Artifacts:**
            - The static site has been built and uploaded as an artifact
            - Download the artifact from the workflow run to preview locally

            **What's included:**
            - ğŸ“– Documentation (Fumadocs)
            - ğŸŒ Landing page (website)

            **Note:** This is a PR preview build. The site will be deployed to GitHub Pages when merged to \`main\`.

            ---
            *Build completed in workflow run #${{ github.run_number }}*`
            });
