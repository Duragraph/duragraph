# DuraGraph Domain Events
# Event schemas for event sourcing

metadata:
  version: "1.0.0"
  pattern: event_sourcing
  conventions:
    naming: "{domain}.{action}"  # e.g., run.created
    timestamps: "occurred_at (UTC with timezone)"
    ids: "UUID strings"

# ============================================
# Run Domain Events
# ============================================
run_events:
  aggregate_type: run
  description: Events related to workflow run lifecycle

  events:
    run.created:
      description: Emitted when a new run is created
      fields:
        run_id:
          type: string
          format: uuid
          required: true
        thread_id:
          type: string
          format: uuid
          required: true
        assistant_id:
          type: string
          format: uuid
          required: true
        input:
          type: object
          required: false
          description: Input provided to start the run
        metadata:
          type: object
          required: false
        occurred_at:
          type: string
          format: datetime
          required: true

    run.started:
      description: Emitted when a run begins execution
      fields:
        run_id:
          type: string
          format: uuid
          required: true
        occurred_at:
          type: string
          format: datetime
          required: true

    run.completed:
      description: Emitted when a run completes successfully
      fields:
        run_id:
          type: string
          format: uuid
          required: true
        output:
          type: object
          required: false
          description: Final output from the run
        occurred_at:
          type: string
          format: datetime
          required: true

    run.failed:
      description: Emitted when a run fails with an error
      fields:
        run_id:
          type: string
          format: uuid
          required: true
        error:
          type: string
          required: true
          description: Error message
        occurred_at:
          type: string
          format: datetime
          required: true

    run.cancelled:
      description: Emitted when a run is cancelled
      fields:
        run_id:
          type: string
          format: uuid
          required: true
        reason:
          type: string
          required: false
          description: Reason for cancellation
        occurred_at:
          type: string
          format: datetime
          required: true

    run.requires_action:
      description: Emitted when a run needs human intervention
      fields:
        run_id:
          type: string
          format: uuid
          required: true
        interrupt_id:
          type: string
          format: uuid
          required: true
        reason:
          type: string
          required: true
          enum: [tool_call, approval_required, input_needed]
        tool_calls:
          type: array
          items:
            type: object
          required: false
          description: Pending tool calls if reason is tool_call
        occurred_at:
          type: string
          format: datetime
          required: true

    run.resumed:
      description: Emitted when a run resumes after human action
      fields:
        run_id:
          type: string
          format: uuid
          required: true
        interrupt_id:
          type: string
          format: uuid
          required: true
        tool_outputs:
          type: array
          items:
            type: object
          required: false
          description: Tool outputs provided by user
        occurred_at:
          type: string
          format: datetime
          required: true

# ============================================
# Assistant Domain Events
# ============================================
assistant_events:
  aggregate_type: assistant
  description: Events related to assistant configuration

  events:
    assistant.created:
      description: Emitted when a new assistant is created
      fields:
        assistant_id:
          type: string
          format: uuid
          required: true
        name:
          type: string
          required: true
        description:
          type: string
          required: false
        model:
          type: string
          required: false
          description: Default LLM model
        instructions:
          type: string
          required: false
          description: System prompt
        tools:
          type: array
          items:
            type: object
          required: false
        metadata:
          type: object
          required: false
        occurred_at:
          type: string
          format: datetime
          required: true

    assistant.updated:
      description: Emitted when an assistant is updated
      fields:
        assistant_id:
          type: string
          format: uuid
          required: true
        name:
          type: string
          required: false
        description:
          type: string
          required: false
        model:
          type: string
          required: false
        instructions:
          type: string
          required: false
        tools:
          type: array
          items:
            type: object
          required: false
        metadata:
          type: object
          required: false
        occurred_at:
          type: string
          format: datetime
          required: true

    assistant.deleted:
      description: Emitted when an assistant is deleted
      fields:
        assistant_id:
          type: string
          format: uuid
          required: true
        occurred_at:
          type: string
          format: datetime
          required: true

# ============================================
# Thread Domain Events
# ============================================
thread_events:
  aggregate_type: thread
  description: Events related to conversation threads

  events:
    thread.created:
      description: Emitted when a new thread is created
      fields:
        thread_id:
          type: string
          format: uuid
          required: true
        metadata:
          type: object
          required: false
        occurred_at:
          type: string
          format: datetime
          required: true

    thread.updated:
      description: Emitted when thread metadata is updated
      fields:
        thread_id:
          type: string
          format: uuid
          required: true
        metadata:
          type: object
          required: false
        occurred_at:
          type: string
          format: datetime
          required: true

    thread.message_added:
      description: Emitted when a message is added to a thread
      fields:
        message_id:
          type: string
          format: uuid
          required: true
        thread_id:
          type: string
          format: uuid
          required: true
        role:
          type: string
          required: true
          enum: [user, assistant, system, tool]
        content:
          type: string
          required: true
        metadata:
          type: object
          required: false
        occurred_at:
          type: string
          format: datetime
          required: true

# ============================================
# Graph Domain Events
# ============================================
graph_events:
  aggregate_type: graph
  description: Events related to workflow graph definitions

  events:
    graph.defined:
      description: Emitted when a graph is defined
      fields:
        graph_id:
          type: string
          format: uuid
          required: true
        assistant_id:
          type: string
          format: uuid
          required: true
        name:
          type: string
          required: true
        version:
          type: string
          required: true
        description:
          type: string
          required: false
        nodes:
          type: array
          items:
            $ref: "#/components/schemas/Node"
          required: true
        edges:
          type: array
          items:
            $ref: "#/components/schemas/Edge"
          required: true
        config:
          type: object
          required: false
        occurred_at:
          type: string
          format: datetime
          required: true

    graph.updated:
      description: Emitted when a graph is updated
      fields:
        graph_id:
          type: string
          format: uuid
          required: true
        name:
          type: string
          required: false
        description:
          type: string
          required: false
        nodes:
          type: array
          items:
            $ref: "#/components/schemas/Node"
          required: false
        edges:
          type: array
          items:
            $ref: "#/components/schemas/Edge"
          required: false
        config:
          type: object
          required: false
        occurred_at:
          type: string
          format: datetime
          required: true

# ============================================
# Execution Domain Events
# ============================================
execution_events:
  aggregate_type: execution
  description: Events related to node execution within a run

  events:
    execution.node_started:
      description: Emitted when a node begins execution
      fields:
        run_id:
          type: string
          format: uuid
          required: true
        node_id:
          type: string
          required: true
        node_type:
          type: string
          required: true
          enum: [start, end, llm, tool, conditional]
        input:
          type: object
          required: false
        occurred_at:
          type: string
          format: datetime
          required: true

    execution.node_completed:
      description: Emitted when a node completes successfully
      fields:
        run_id:
          type: string
          format: uuid
          required: true
        node_id:
          type: string
          required: true
        node_type:
          type: string
          required: true
        output:
          type: object
          required: false
        duration_ms:
          type: integer
          required: true
          description: Execution duration in milliseconds
        occurred_at:
          type: string
          format: datetime
          required: true

    execution.node_failed:
      description: Emitted when a node fails
      fields:
        run_id:
          type: string
          format: uuid
          required: true
        node_id:
          type: string
          required: true
        node_type:
          type: string
          required: true
        error:
          type: string
          required: true
        input:
          type: object
          required: false
        occurred_at:
          type: string
          format: datetime
          required: true

    execution.node_skipped:
      description: Emitted when a node is skipped
      fields:
        run_id:
          type: string
          format: uuid
          required: true
        node_id:
          type: string
          required: true
        node_type:
          type: string
          required: true
        reason:
          type: string
          required: true
        occurred_at:
          type: string
          format: datetime
          required: true

# ============================================
# Interrupt Domain Events
# ============================================
interrupt_events:
  aggregate_type: interrupt
  description: Events related to human-in-the-loop interrupts

  events:
    interrupt.created:
      description: Emitted when an interrupt is created
      fields:
        interrupt_id:
          type: string
          format: uuid
          required: true
        run_id:
          type: string
          format: uuid
          required: true
        node_id:
          type: string
          required: true
        reason:
          type: string
          required: true
          enum: [tool_call, approval_required, input_needed]
        state:
          type: object
          required: true
          description: Execution state at time of interrupt
        tool_calls:
          type: array
          items:
            type: object
          required: false
        occurred_at:
          type: string
          format: datetime
          required: true

    interrupt.resolved:
      description: Emitted when an interrupt is resolved
      fields:
        interrupt_id:
          type: string
          format: uuid
          required: true
        run_id:
          type: string
          format: uuid
          required: true
        tool_outputs:
          type: array
          items:
            type: object
          required: false
        occurred_at:
          type: string
          format: datetime
          required: true

# ============================================
# Component Schemas
# ============================================
components:
  schemas:
    Node:
      type: object
      properties:
        id:
          type: string
          required: true
        type:
          type: string
          required: true
          enum: [start, end, llm, tool, conditional]
        config:
          type: object
          required: false

    Edge:
      type: object
      properties:
        source:
          type: string
          required: true
        target:
          type: string
          required: true
        condition:
          type: string
          required: false
          description: Condition expression for conditional edges

    EventMetadata:
      type: object
      description: Standard metadata included with all events
      properties:
        correlation_id:
          type: string
          format: uuid
          description: ID linking related events across aggregates
        causation_id:
          type: string
          format: uuid
          description: ID of the event that caused this event
        user_id:
          type: string
          format: uuid
          description: ID of user who triggered the action
        trace_id:
          type: string
          description: Distributed tracing ID
