asyncapi: 3.0.0
info:
  title: DuraGraph Async API
  version: 1.0.0
  description: |
    NATS JetStream event-driven architecture for DuraGraph.

    This specification defines all events published and consumed across the system,
    enabling reliable message delivery between services and workers.

    ## Architecture Overview
    - **API Server (Go)**: Publishes domain events via outbox pattern
    - **Outbox Relay**: Polls outbox table and publishes to NATS
    - **Workers**: Process graph execution, LLM calls, tool execution
    - **SSE Handler**: Streams events to connected clients

    ## Delivery Guarantees
    - At-least-once delivery for all streams
    - Message ordering guaranteed per subject
    - Durable consumers for reliable processing
  contact:
    name: DuraGraph Team
  license:
    name: Apache 2.0

defaultContentType: application/json

servers:
  production:
    host: nats.duragraph.io:4222
    protocol: nats
    description: Production NATS cluster
    tags:
      - name: production

  development:
    host: localhost:4222
    protocol: nats
    description: Local development NATS server
    tags:
      - name: development

channels:
  # ============================================
  # Run Domain Events
  # ============================================
  run.created:
    address: run.created
    description: Published when a new workflow run is created
    messages:
      runCreated:
        $ref: '#/components/messages/RunCreated'
    bindings:
      nats:
        jetstream:
          stream: RUNS
          consumer: run-processor

  run.started:
    address: run.started
    description: Published when a run begins execution
    messages:
      runStarted:
        $ref: '#/components/messages/RunStarted'
    bindings:
      nats:
        jetstream:
          stream: RUNS

  run.completed:
    address: run.completed
    description: Published when a run completes successfully
    messages:
      runCompleted:
        $ref: '#/components/messages/RunCompleted'
    bindings:
      nats:
        jetstream:
          stream: RUNS

  run.failed:
    address: run.failed
    description: Published when a run fails
    messages:
      runFailed:
        $ref: '#/components/messages/RunFailed'
    bindings:
      nats:
        jetstream:
          stream: RUNS

  run.cancelled:
    address: run.cancelled
    description: Published when a run is cancelled
    messages:
      runCancelled:
        $ref: '#/components/messages/RunCancelled'
    bindings:
      nats:
        jetstream:
          stream: RUNS

  run.requires_action:
    address: run.requires_action
    description: Published when a run needs human intervention
    messages:
      runRequiresAction:
        $ref: '#/components/messages/RunRequiresAction'
    bindings:
      nats:
        jetstream:
          stream: RUNS

  run.resumed:
    address: run.resumed
    description: Published when a run resumes after human action
    messages:
      runResumed:
        $ref: '#/components/messages/RunResumed'
    bindings:
      nats:
        jetstream:
          stream: RUNS

  # ============================================
  # Execution Domain Events
  # ============================================
  execution.node_started:
    address: execution.node_started
    description: Published when a node begins execution
    messages:
      nodeStarted:
        $ref: '#/components/messages/NodeStarted'
    bindings:
      nats:
        jetstream:
          stream: EXECUTION
          consumer: execution-tracker

  execution.node_completed:
    address: execution.node_completed
    description: Published when a node completes
    messages:
      nodeCompleted:
        $ref: '#/components/messages/NodeCompleted'
    bindings:
      nats:
        jetstream:
          stream: EXECUTION

  execution.node_failed:
    address: execution.node_failed
    description: Published when a node fails
    messages:
      nodeFailed:
        $ref: '#/components/messages/NodeFailed'
    bindings:
      nats:
        jetstream:
          stream: EXECUTION

  # ============================================
  # Interrupt Domain Events
  # ============================================
  interrupt.created:
    address: interrupt.created
    description: Published when an interrupt is created
    messages:
      interruptCreated:
        $ref: '#/components/messages/InterruptCreated'
    bindings:
      nats:
        jetstream:
          stream: INTERRUPTS

  interrupt.resolved:
    address: interrupt.resolved
    description: Published when an interrupt is resolved
    messages:
      interruptResolved:
        $ref: '#/components/messages/InterruptResolved'
    bindings:
      nats:
        jetstream:
          stream: INTERRUPTS

  # ============================================
  # Worker Commands (Request/Reply)
  # ============================================
  worker.graph.execute:
    address: worker.graph.execute
    description: Command to execute a graph
    messages:
      executeGraph:
        $ref: '#/components/messages/ExecuteGraphCommand'
    bindings:
      nats:
        jetstream:
          stream: WORKER_COMMANDS
          consumer: graph-executor

  worker.llm.invoke:
    address: worker.llm.invoke
    description: Command to invoke an LLM
    messages:
      invokeLLM:
        $ref: '#/components/messages/InvokeLLMCommand'
    bindings:
      nats:
        jetstream:
          stream: WORKER_COMMANDS
          consumer: llm-worker

  worker.tool.execute:
    address: worker.tool.execute
    description: Command to execute a tool
    messages:
      executeTool:
        $ref: '#/components/messages/ExecuteToolCommand'
    bindings:
      nats:
        jetstream:
          stream: WORKER_COMMANDS
          consumer: tool-worker

# ============================================
# Operations
# ============================================
operations:
  publishRunCreated:
    action: send
    channel:
      $ref: '#/channels/run.created'
    description: Publish run created event from API server

  subscribeRunCreated:
    action: receive
    channel:
      $ref: '#/channels/run.created'
    description: Subscribe to run created events for processing

  publishNodeCompleted:
    action: send
    channel:
      $ref: '#/channels/execution.node_completed'
    description: Publish node completion from worker

  executeGraph:
    action: send
    channel:
      $ref: '#/channels/worker.graph.execute'
    description: Send graph execution command to worker

# ============================================
# Components
# ============================================
components:
  messages:
    # Run Events
    RunCreated:
      name: RunCreated
      title: Run Created Event
      contentType: application/json
      payload:
        $ref: '#/components/schemas/RunCreatedPayload'

    RunStarted:
      name: RunStarted
      title: Run Started Event
      contentType: application/json
      payload:
        $ref: '#/components/schemas/RunStartedPayload'

    RunCompleted:
      name: RunCompleted
      title: Run Completed Event
      contentType: application/json
      payload:
        $ref: '#/components/schemas/RunCompletedPayload'

    RunFailed:
      name: RunFailed
      title: Run Failed Event
      contentType: application/json
      payload:
        $ref: '#/components/schemas/RunFailedPayload'

    RunCancelled:
      name: RunCancelled
      title: Run Cancelled Event
      contentType: application/json
      payload:
        $ref: '#/components/schemas/RunCancelledPayload'

    RunRequiresAction:
      name: RunRequiresAction
      title: Run Requires Action Event
      contentType: application/json
      payload:
        $ref: '#/components/schemas/RunRequiresActionPayload'

    RunResumed:
      name: RunResumed
      title: Run Resumed Event
      contentType: application/json
      payload:
        $ref: '#/components/schemas/RunResumedPayload'

    # Execution Events
    NodeStarted:
      name: NodeStarted
      title: Node Started Event
      contentType: application/json
      payload:
        $ref: '#/components/schemas/NodeStartedPayload'

    NodeCompleted:
      name: NodeCompleted
      title: Node Completed Event
      contentType: application/json
      payload:
        $ref: '#/components/schemas/NodeCompletedPayload'

    NodeFailed:
      name: NodeFailed
      title: Node Failed Event
      contentType: application/json
      payload:
        $ref: '#/components/schemas/NodeFailedPayload'

    # Interrupt Events
    InterruptCreated:
      name: InterruptCreated
      title: Interrupt Created Event
      contentType: application/json
      payload:
        $ref: '#/components/schemas/InterruptCreatedPayload'

    InterruptResolved:
      name: InterruptResolved
      title: Interrupt Resolved Event
      contentType: application/json
      payload:
        $ref: '#/components/schemas/InterruptResolvedPayload'

    # Worker Commands
    ExecuteGraphCommand:
      name: ExecuteGraphCommand
      title: Execute Graph Command
      contentType: application/json
      payload:
        $ref: '#/components/schemas/ExecuteGraphPayload'

    InvokeLLMCommand:
      name: InvokeLLMCommand
      title: Invoke LLM Command
      contentType: application/json
      payload:
        $ref: '#/components/schemas/InvokeLLMPayload'

    ExecuteToolCommand:
      name: ExecuteToolCommand
      title: Execute Tool Command
      contentType: application/json
      payload:
        $ref: '#/components/schemas/ExecuteToolPayload'

  schemas:
    # Run Event Payloads
    RunCreatedPayload:
      type: object
      required:
        - run_id
        - thread_id
        - assistant_id
        - occurred_at
      properties:
        run_id:
          type: string
          format: uuid
        thread_id:
          type: string
          format: uuid
        assistant_id:
          type: string
          format: uuid
        input:
          type: object
        metadata:
          type: object
        occurred_at:
          type: string
          format: date-time

    RunStartedPayload:
      type: object
      required:
        - run_id
        - occurred_at
      properties:
        run_id:
          type: string
          format: uuid
        occurred_at:
          type: string
          format: date-time

    RunCompletedPayload:
      type: object
      required:
        - run_id
        - occurred_at
      properties:
        run_id:
          type: string
          format: uuid
        output:
          type: object
        occurred_at:
          type: string
          format: date-time

    RunFailedPayload:
      type: object
      required:
        - run_id
        - error
        - occurred_at
      properties:
        run_id:
          type: string
          format: uuid
        error:
          type: string
        occurred_at:
          type: string
          format: date-time

    RunCancelledPayload:
      type: object
      required:
        - run_id
        - occurred_at
      properties:
        run_id:
          type: string
          format: uuid
        reason:
          type: string
        occurred_at:
          type: string
          format: date-time

    RunRequiresActionPayload:
      type: object
      required:
        - run_id
        - interrupt_id
        - reason
        - occurred_at
      properties:
        run_id:
          type: string
          format: uuid
        interrupt_id:
          type: string
          format: uuid
        reason:
          type: string
          enum: [tool_call, approval_required, input_needed]
        tool_calls:
          type: array
          items:
            type: object
        occurred_at:
          type: string
          format: date-time

    RunResumedPayload:
      type: object
      required:
        - run_id
        - interrupt_id
        - occurred_at
      properties:
        run_id:
          type: string
          format: uuid
        interrupt_id:
          type: string
          format: uuid
        tool_outputs:
          type: array
          items:
            type: object
        occurred_at:
          type: string
          format: date-time

    # Execution Event Payloads
    NodeStartedPayload:
      type: object
      required:
        - run_id
        - node_id
        - node_type
        - occurred_at
      properties:
        run_id:
          type: string
          format: uuid
        node_id:
          type: string
        node_type:
          type: string
          enum: [start, end, llm, tool, conditional]
        input:
          type: object
        occurred_at:
          type: string
          format: date-time

    NodeCompletedPayload:
      type: object
      required:
        - run_id
        - node_id
        - node_type
        - duration_ms
        - occurred_at
      properties:
        run_id:
          type: string
          format: uuid
        node_id:
          type: string
        node_type:
          type: string
        output:
          type: object
        duration_ms:
          type: integer
        occurred_at:
          type: string
          format: date-time

    NodeFailedPayload:
      type: object
      required:
        - run_id
        - node_id
        - node_type
        - error
        - occurred_at
      properties:
        run_id:
          type: string
          format: uuid
        node_id:
          type: string
        node_type:
          type: string
        error:
          type: string
        input:
          type: object
        occurred_at:
          type: string
          format: date-time

    # Interrupt Event Payloads
    InterruptCreatedPayload:
      type: object
      required:
        - interrupt_id
        - run_id
        - node_id
        - reason
        - state
        - occurred_at
      properties:
        interrupt_id:
          type: string
          format: uuid
        run_id:
          type: string
          format: uuid
        node_id:
          type: string
        reason:
          type: string
          enum: [tool_call, approval_required, input_needed]
        state:
          type: object
        tool_calls:
          type: array
          items:
            type: object
        occurred_at:
          type: string
          format: date-time

    InterruptResolvedPayload:
      type: object
      required:
        - interrupt_id
        - run_id
        - occurred_at
      properties:
        interrupt_id:
          type: string
          format: uuid
        run_id:
          type: string
          format: uuid
        tool_outputs:
          type: array
          items:
            type: object
        occurred_at:
          type: string
          format: date-time

    # Worker Command Payloads
    ExecuteGraphPayload:
      type: object
      required:
        - run_id
        - graph_id
        - input
      properties:
        run_id:
          type: string
          format: uuid
        graph_id:
          type: string
          format: uuid
        input:
          type: object
        state:
          type: object
          description: Current execution state

    InvokeLLMPayload:
      type: object
      required:
        - run_id
        - node_id
        - model
        - messages
      properties:
        run_id:
          type: string
          format: uuid
        node_id:
          type: string
        model:
          type: string
          description: LLM model to use (e.g., gpt-4, claude-3)
        messages:
          type: array
          items:
            type: object
            properties:
              role:
                type: string
              content:
                type: string
        tools:
          type: array
          items:
            type: object
        temperature:
          type: number
        max_tokens:
          type: integer

    ExecuteToolPayload:
      type: object
      required:
        - run_id
        - node_id
        - tool_name
        - arguments
      properties:
        run_id:
          type: string
          format: uuid
        node_id:
          type: string
        tool_name:
          type: string
        arguments:
          type: object

# ============================================
# JetStream Configuration
# ============================================
x-jetstream-config:
  streams:
    RUNS:
      description: Run lifecycle events
      subjects:
        - run.*
      retention: limits
      max_age: 7d
      max_bytes: 1GB
      storage: file
      replicas: 1

    EXECUTION:
      description: Node execution events
      subjects:
        - execution.*
      retention: limits
      max_age: 24h
      max_bytes: 500MB
      storage: file
      replicas: 1

    INTERRUPTS:
      description: Human-in-the-loop interrupt events
      subjects:
        - interrupt.*
      retention: limits
      max_age: 7d
      max_bytes: 100MB
      storage: file
      replicas: 1

    WORKER_COMMANDS:
      description: Commands for workers
      subjects:
        - worker.>
      retention: workqueue
      max_age: 1h
      storage: file
      replicas: 1

  consumers:
    run-processor:
      stream: RUNS
      durable_name: run-processor
      deliver_policy: all
      ack_policy: explicit
      ack_wait: 30s
      max_deliver: 3

    graph-executor:
      stream: WORKER_COMMANDS
      durable_name: graph-executor
      filter_subject: worker.graph.execute
      deliver_policy: all
      ack_policy: explicit
      ack_wait: 5m
      max_deliver: 3

    llm-worker:
      stream: WORKER_COMMANDS
      durable_name: llm-worker
      filter_subject: worker.llm.invoke
      deliver_policy: all
      ack_policy: explicit
      ack_wait: 2m
      max_deliver: 3

    tool-worker:
      stream: WORKER_COMMANDS
      durable_name: tool-worker
      filter_subject: worker.tool.execute
      deliver_policy: all
      ack_policy: explicit
      ack_wait: 1m
      max_deliver: 3
